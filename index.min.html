<!doctypehtml><meta charset="utf-8"><title>WebRTC p2p data</title><style>*{box-sizing:border-box}.connect textarea{display:block;width:calc(100vw - 16px);height:calc(100vh - 16px - 3em);margin-bottom:1em}.chat{display:none}.chat div{width:calc(100vw - 16px);max-height:calc(100vw - 16px - 11em);overflow-x:hidden;overflow-y:auto}p.from-me{color:green}p.from-you{color:blue}</style><div class="connect"><textarea></textarea> <button>create Connection</button></div><div class="chat"><div></div><input placeholder="Type your message here"> <button type="submit"class="btn">Send message</button></div><script type="module">"use strict";function timestamp(){return(new Date).toTimeString().substr(0,8)}class GUI extends EventTarget{constructor(e){super(),this.target=e,this.connect=document.querySelector(".connect"),this.connect.querySelector("button").addEventListener("click",e=>this.clickConnect()),this.descriptionBox=this.connect.querySelector("textarea"),this.descriptionBox.value="",this.chat=document.querySelector(".chat"),this.chat.querySelector("button").addEventListener("click",e=>this.sendMessage()),this.messageBox=this.chat.querySelector('input[type="text"]'),this.chatBox=this.chat.querySelector("div"),this.addEventListener("candidate",e=>this.descriptionBox.value=JSON.stringify(e.detail)),this.addEventListener("connect",e=>{this.connect.style.display="none",this.chat.style.display="initial"}),this.addEventListener("message",e=>this._addChatLine(e.detail,"you"))}trigger(e,t){this.target.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:t}))}clickConnect(){const e=this.descriptionBox.value;try{this.trigger("connect",JSON.parse(e))}catch(e){this.trigger("connect")}this.descriptionBox.value=""}sendMessage(){const e=this.messageBox.value;e.length&&(this._addChatLine(e,"me"),this.trigger("message",e)),this.messageBox.value=""}_addChatLine(e,t){this.chatBox.insertAdjacentHTML("beforeend",`<p class="from-${t}">[${timestamp()}] ${e}</p>`),this.chatBox.scrollTop=this.chatBox.scrollHeight}}class webRTC extends EventTarget{constructor(e){super(),this.connection=new RTCPeerConnection({iceServers:e}),this.connection.addEventListener("icecandidate",e=>null===e.candidate&&this.trigger("candidate",this.connection.localDescription)),this.connection.addEventListener("datachannel",e=>this.connectChannel(e.channel)),this.addEventListener("connect",this.connectHandler)}weave(e){this.target=e}trigger(e,t){this.target.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:t}))}connectHandler(e){switch(this.connection.signalingState){case"stable":null===e.detail?(this.setupChannel(),this.connection.createOffer().then(e=>this.connection.setLocalDescription(e))):(this.connection.setRemoteDescription(e.detail),this.connection.createAnswer().then(e=>this.connection.setLocalDescription(e)));break;case"have-local-offer":this.connection.setRemoteDescription(e.detail)}}setupChannel(){this.connectChannel(this.connection.createDataChannel("channel"))}connectChannel(e){e.addEventListener("open",e=>this.trigger("connect")),e.addEventListener("message",e=>this.trigger("message",e.data)),this.addEventListener("message",t=>e.send(t.detail))}}const stunServers=[{urls:"stun:stun.schlund.de"}],webRtc=new webRTC(stunServers),gui=new GUI(webRtc);webRtc.weave(gui);</script>